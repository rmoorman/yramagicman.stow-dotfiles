#!/usr/bin/env zsh

function update() {
    sudo -v
    gup

    if [[ $(command -v home-manager) ]]  ; then
        home-manager expire-generations "-14 days"
    fi
    if [[ $(command -v nixos-rebuild) ]] ; then
        # Git/nix are fixed, but committing the flake.lock is not
        # something I'm interested in.
        (
            print -v thing -P %x
            conf="$(builtin cd ${thing/update/} && git rev-parse --show-toplevel )"
            echo "\n\n$conf\n\n"
            rm -f "$conf/flake.lock"
            sudo nixos-rebuild boot --flake "$conf/#"  --upgrade-all
            builtin cd $conf
            git add "$conf/flake.lock"
            git commit -m "flake.lock update $(date -I)"
        )
        sudo nix-channel --update
        nix-collect-garbage -d --delete-older-than 14d
        nix store optimise
    elif [[ $(command -v yay) ]]; then
        yay -Syu --noconfirm --sudoloop
        xmonad --recompile
        orphans
        echo '' > /tmp/updates
    elif [[ $(command -v pacman) ]]; then
        pacman -Syu --noconfirm
        xmonad --recompile
        orphans
        echo '' > /tmp/updates
    elif [[ $(command -v apt) ]]; then
        sudo apt update
        sudo apt full-upgrade -y
    elif [[ $(command -v zypper) ]]; then
        sudo zypper refresh
        sudo zypper dup
    elif [[ $(command -v freebsd-update) ]]; then
        sudo freebsd-update fetch
        sudo freebsd-update install
        sudo pkg update
        sudo pkg upgrade
    fi

    if [[ $(command -v home-manager) ]] &&  [[ ! $(command -v nixos-rebuild) ]] ; then
        home-manager switch
        nix-collect-garbage -d --delete-older-than 14d
        nix store optimise
    fi
    if [[ $(command -v flatpak) ]] && [[ -z $SSH_CLIENT ]] ; then
        echo "\n flatpak \n"
        flatpak update -y
    fi
    bell
}

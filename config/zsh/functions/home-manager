#!/usr/bin/env zsh

function home-manager () {
    [[ "$(uname -n)" == 'debian' ]] &&  export NIXPKGS_ALLOW_UNFREE=1
    tmp="$(mktemp -d)"
    print -v thing -P %x
    conf="$(builtin cd ${thing/home-manager/} && git rev-parse --show-toplevel )"
    command cp -r $conf/nixos/* $tmp/
    case "$1" in
        "switch" )
           [[ "$(uname -n)" == 'debian' ]] && command home-manager switch --impure --flake "$tmp/#jonathan"

           [[ "$(uname -n)" == 'debian' ]] || command home-manager switch --flake "$tmp/#jonathan"

           home-manager expire-generations "-14 days"
           nix-collect-garbage -d --delete-older-than 14d
           nix store optimise
           return
           ;;
       * )
           command home-manager $@
           return
           ;;
   esac
}

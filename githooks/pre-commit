#!/bin/sh
base=$(git rev-parse --show-toplevel)
while read -r f
do
    if ! test -f "$base/$f.gpg"; then
        # echo 'make file'
        gpg -r jonathandavis@gilsons.org --encrypt "$base/$f"
    fi
    if git status | grep -q "$f"; then
        gpg -d --quiet "$base/$f.gpg" > "/tmp/$(basename "$f" )"
        if  /usr/bin/diff -q "$base/$f" "/tmp/$(basename "$f" )"; then
            if git ls-files | grep -q "$f"; then
                git rm --cached "$base/$f" > /dev/null 2>&1
            fi
            rm "/tmp/$(basename "$f" )"
        else
            echo encrypt
            rm "$base/$f.gpg"
            gpg -r jonathandavis@gilsons.org --encrypt "$base/$f"
            if git ls-files | grep -q "$f"; then
                git rm --cached "$base/$f" > /dev/null 2>&1
            fi
            git add "$base/$f.gpg"
            rm "/tmp/$(basename "$f" )"
        fi
    fi
    if test -f "/tmp/$f"; then
        rm "/tmp/$(basename "$f" )"
    fi
done < "$base/config/crypt"
exit 0
